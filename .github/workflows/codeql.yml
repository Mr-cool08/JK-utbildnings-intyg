name: Tests & Codacy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  tests-and-coverage:
    name: Pytest + coverage -> Codacy
    runs-on: ubuntu-latest

    env:
      # Använd lokal SQLite istället för Postgres i CI
      ENABLE_LOCAL_TEST_DB: "true"
      LOCAL_TEST_DB_PATH: "instance/test_ci.db"
      FLASK_ENV: "testing"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # pysqlite3-binary används för < 3.12 i requirements.txt
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov

      - name: Prepare .env for tests
        run: |
          # Använd din exempelkonfiguration som bas
          cp .example.env .env
          # Överskriv med test-vänliga inställningar
          {
            echo "";
            echo "ENABLE_LOCAL_TEST_DB=true";
            echo "LOCAL_TEST_DB_PATH=instance/test_ci.db";
          } >> .env

      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term
        # pytest-cov skapar filen "coverage.xml" i repo-roten

      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@v1.3.0
        with:
          # Skapa den i GitHub under Settings -> Secrets -> Actions
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage.xml

  codacy-analysis-cli:
    name: Codacy static analysis
    runs-on: ubuntu-latest
    # Kör separat från testerna – ändra till "needs: tests-and-coverage"
    # om du vill att analysen bara ska köras när testerna går igenom.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Codacy Analysis CLI
        uses: codacy/codacy-analysis-cli-action@master
        # Standardläge: kör alla verktyg Codacy stödjer för Python-koden
        # och failar jobben om den hittar issues.
