name: Security - Bandit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  bandit:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit (JSON)
        run: |
          bandit -r . -f json -o bandit.json

      - name: Convert Bandit JSON to SARIF
        run: |
          python - << 'PY'
          import json
          from pathlib import Path

          input_path = Path("bandit.json")
          output_path = Path("bandit.sarif")

          data = json.loads(input_path.read_text(encoding="utf-8"))
          results = data.get("results", [])

          def level_for(severity: str) -> str:
              sev = (severity or "").lower()
              if sev == "high":
                  return "error"
              if sev == "medium":
                  return "warning"
              return "note"

          rules = {}
          sarif_results = []

          for item in results:
              rule_id = item.get("test_id", "BANDIT")
              rule_name = item.get("test_name") or rule_id
              message = item.get("issue_text") or rule_name
              severity = item.get("issue_severity")
              filename = item.get("filename")
              line = item.get("line_number") or 1

              if rule_id not in rules:
                  rules[rule_id] = {
                      "id": rule_id,
                      "name": rule_name,
                      "shortDescription": {"text": rule_name},
                      "fullDescription": {"text": rule_name},
                  }

              sarif_results.append(
                  {
                      "ruleId": rule_id,
                      "level": level_for(severity),
                      "message": {"text": message},
                      "locations": [
                          {
                              "physicalLocation": {
                                  "artifactLocation": {"uri": filename},
                                  "region": {"startLine": line},
                              }
                          }
                      ],
                  }
              )

          sarif = {
              "version": "2.1.0",
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "runs": [
                  {
                      "tool": {
                          "driver": {
                              "name": "Bandit",
                              "informationUri": "https://bandit.readthedocs.io/",
                              "rules": list(rules.values()),
                          }
                      },
                      "results": sarif_results,
                  }
              ],
          }

          output_path.write_text(json.dumps(sarif), encoding="utf-8")
          PY

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif
