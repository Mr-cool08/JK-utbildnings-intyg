services:
  nginx:
    image: nginx:1.27-alpine
    depends_on:
      - app
      - app_demo
      - status_page
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${ORIGIN_CERT_PATH}:/etc/nginx/certs/origin.crt:ro
      - ${ORIGIN_KEY_PATH}:/etc/nginx/certs/origin.key:ro
      - nginx_logs:/var/log/nginx
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
      - source: nginx_app_conf
        target: /etc/nginx/conf.d/app.conf
      - source: nginx_cloudflare_conf
        target: /etc/nginx/conf.d/cloudflare-realip.conf
    networks:
      - public_net
    restart: unless-stopped

  app:
    build: .
    env_file:
      - stack.env
    environment:
      LOG_DIR: /app/logs
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    expose:
      - "80"
    volumes:
      - env_data:/config
      - uploads_data:/app/uploads
      - app_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - public_net
      - db_net
    restart: unless-stopped

  app_demo:
    build: .
    env_file:
      - stack.env
    environment:
      LOG_DIR: /app/logs
      ENABLE_DEMO_MODE: "true"
      ENABLE_LOCAL_TEST_DB: "true"
      LOCAL_TEST_DB_PATH: "/tmp/demo-app.db"
      SECRET_KEY: ${DEMO_SECRET_KEY}
      HASH_SALT: ${DEMO_HASH_SALT}
      DEMO_USER_EMAIL: ${DEMO_USER_EMAIL}
      DEMO_USER_NAME: ${DEMO_USER_NAME}
      DEMO_USER_PERSONNUMMER: ${DEMO_USER_PERSONNUMMER}
      DEMO_USER_PASSWORD: ${DEMO_USER_PASSWORD}
      DEMO_SUPERVISOR_EMAIL: ${DEMO_SUPERVISOR_EMAIL}
      DEMO_SUPERVISOR_NAME: ${DEMO_SUPERVISOR_NAME}
      DEMO_SUPERVISOR_PASSWORD: ${DEMO_SUPERVISOR_PASSWORD}
      DEMO_SUPERVISOR_ORGNR: ${DEMO_SUPERVISOR_ORGNR}
    expose:
      - "80"
    volumes:
      - env_data:/config
      - uploads_data:/app/uploads
      - app_logs:/app/logs
    networks:
      - public_net
    restart: unless-stopped

  status_page:
    build:
      context: .
      dockerfile: status_service/Dockerfile
    env_file:
      - stack.env
    environment:
      STATUS_DB_HOST: postgres
      STATUS_DB_NAME: ${POSTGRES_DB}
      STATUS_DB_USER: ${POSTGRES_USER}
      STATUS_DB_PASSWORD: ${POSTGRES_PASSWORD}
      STATUS_SSL_HOST: https://utbildningsintyg.se
      STATUS_NGINX_HOST: nginx
      STATUS_NGINX_PORT: "80"
    expose:
      - "80"
    networks:
      - public_net
      - db_net
    restart: unless-stopped

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} -h 127.0.0.1 -p 5432"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s
    networks:
      - db_net
    restart: unless-stopped

  postgres_backup:
    image: postgres:16
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      BACKUP_DIR: /backups
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
      BACKUP_INTERVAL_SECONDS: ${BACKUP_INTERVAL_SECONDS:-86400}
    volumes:
      - pgdata_backups:/backups
      - ./scripts/backup:/scripts:ro
    command: ["/bin/sh", "/scripts/postgres_backup.sh", "--loop"]
    networks:
      - db_net
    restart: unless-stopped

volumes:
  env_data:
  uploads_data:
  app_logs:
  nginx_logs:
  pgdata:
  pgdata_backups:

configs:
  nginx_conf:
    content: |
      # Nginx grundkonfiguration för JK Utbildningsintyg
      user  nginx;
      worker_processes auto;

      error_log  /var/log/nginx/error.log warn;
      pid        /var/run/nginx.pid;

      events {
          worker_connections 1024;
      }

      http {
          include       /etc/nginx/mime.types;
          default_type  application/octet-stream;

          log_format  main  '$$remote_addr - $$remote_user [$$time_local] "$$request" '
                            '$$status $$body_bytes_sent "$$http_referer" '
                            '"$$http_user_agent" "$$http_x_forwarded_for"';

          access_log  /var/log/nginx/access.log  main;

          sendfile        on;
          keepalive_timeout  65;
          server_tokens off;

          map $$http_upgrade $$connection_upgrade {
              default upgrade;
              ''      close;
          }

          include /etc/nginx/conf.d/*.conf;
      }

  nginx_app_conf:
    content: |
      # Nginx reverse proxy för JK Utbildningsintyg

      # Cloudflare IP-ranges genereras i deploy/nginx/conf.d/cloudflare-realip.conf
      #include /etc/nginx/conf.d/cloudflare-realip.conf; 

      upstream jk_utbildningsintyg_app {
          server app:80;
      }

      upstream jk_utbildningsintyg_app_demo {
          server app_demo:80;
      }

      upstream jk_utbildningsintyg_status_page {
          server status_page:80;
      }

      server {
          listen 80;
          server_name demo.utbildningsintyg.se;

          return 301 https://$$host$$request_uri;
      }

      server {
          listen 80;
          server_name utbildningsintyg.se www.utbildningsintyg.se;

          return 301 https://$$host$$request_uri;
      }

      server {
          listen 80;
          server_name status.utbildningsintyg.se;

          return 301 https://$$host$$request_uri;
      }

      server {
          listen 443 ssl;
          http2 on;
          server_name demo.utbildningsintyg.se;

          ssl_certificate /etc/nginx/certs/origin.crt;
          ssl_certificate_key /etc/nginx/certs/origin.key;
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_prefer_server_ciphers on;
          ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

          client_max_body_size 100m;

          add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Referrer-Policy "no-referrer" always;
          add_header X-Frame-Options "DENY" always;
          add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

          location / {
              proxy_pass http://jk_utbildningsintyg_app_demo;
              proxy_http_version 1.1;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
              proxy_set_header X-Forwarded-Host $$host;
              proxy_set_header X-Forwarded-Port $$server_port;
              proxy_set_header Upgrade $$http_upgrade;
              proxy_set_header Connection $$connection_upgrade;
              proxy_read_timeout 60s;
              proxy_send_timeout 60s;
          }
      }

      server {
          listen 443 ssl;
          http2 on;
          server_name utbildningsintyg.se www.utbildningsintyg.se;

          ssl_certificate /etc/nginx/certs/origin.crt;
          ssl_certificate_key /etc/nginx/certs/origin.key;
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_prefer_server_ciphers on;
          ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';


          client_max_body_size 100m;

          add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Referrer-Policy "no-referrer" always;
          add_header X-Frame-Options "DENY" always;
          add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

          location / {
              proxy_pass http://jk_utbildningsintyg_app;
              proxy_http_version 1.1;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
              proxy_set_header X-Forwarded-Host $$host;
              proxy_set_header X-Forwarded-Port $$server_port;
              proxy_set_header Upgrade $$http_upgrade;
              proxy_set_header Connection $$connection_upgrade;
              proxy_read_timeout 60s;
              proxy_send_timeout 60s;
          }
      }

      server {
          listen 443 ssl;
          http2 on;
          server_name status.utbildningsintyg.se;

          ssl_certificate /etc/nginx/certs/origin.crt;
          ssl_certificate_key /etc/nginx/certs/origin.key;
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_prefer_server_ciphers on;
          ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

          add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header Referrer-Policy "no-referrer" always;
          add_header X-Frame-Options "DENY" always;
          add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

          location / {
              proxy_pass http://jk_utbildningsintyg_status_page;
              proxy_http_version 1.1;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
              proxy_set_header X-Forwarded-Host $$host;
              proxy_set_header X-Forwarded-Port $$server_port;
              proxy_read_timeout 60s;
              proxy_send_timeout 60s;
          }
      }

  nginx_cloudflare_conf:
    content: |
      # Autogenererad Cloudflare realip-konfiguration
      # Uppdaterad: manuellt, kör scripts/generate_cloudflare_ips.sh för ny lista
      real_ip_header CF-Connecting-IP;
      real_ip_recursive on;

      set_real_ip_from 173.245.48.0/20;
      set_real_ip_from 103.21.244.0/22;
      set_real_ip_from 103.22.200.0/22;
      set_real_ip_from 103.31.4.0/22;
      set_real_ip_from 141.101.64.0/18;
      set_real_ip_from 108.162.192.0/18;
      set_real_ip_from 190.93.240.0/20;
      set_real_ip_from 188.114.96.0/20;
      set_real_ip_from 197.234.240.0/22;
      set_real_ip_from 198.41.128.0/17;
      set_real_ip_from 162.158.0.0/15;
      set_real_ip_from 104.16.0.0/13;
      set_real_ip_from 104.24.0.0/14;
      set_real_ip_from 172.64.0.0/13;
      set_real_ip_from 131.0.72.0/22;
      set_real_ip_from 2400:cb00::/32;
      set_real_ip_from 2606:4700::/32;
      set_real_ip_from 2803:f800::/32;
      set_real_ip_from 2405:8100::/32;
      set_real_ip_from 2405:b500::/32;
      set_real_ip_from 2a06:98c0::/29;
      set_real_ip_from 2c0f:f248::/32;

networks:
  public_net:
    name: ${PUBLIC_NETWORK_NAME:-jk_public_net}
  db_net:
    internal: true
