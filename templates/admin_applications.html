{% extends 'base.html' %}
{% block title %}Admin — Ansökningar{% endblock %}
{% block content %}
<h1>Admin — Ansökningar</h1>
<p>Hantera inkomna kontoansökningar. Alla ändringar loggas och godkännanden skickar automatiskt ett e-postmeddelande till kontaktpersonen.</p>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const detailButtons = document.querySelectorAll('.show-details-btn');

    detailButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const appId = btn.getAttribute('data-app-id');
            const details = document.getElementById(`details-${appId}`);

            if (details.hasAttribute('hidden')) {
                details.removeAttribute('hidden');
                btn.textContent = 'Dölj information';
            } else {
                details.setAttribute('hidden', '');
                btn.textContent = 'Visa mer information';
            }
        });
    });
});
</script>

<section class="panel admin-applications" data-csrf-token="{{ csrf_token }}">
    <header class="panel-header">
        <h2>Inkomna ansökningar</h2>
        <div class="filter-group">
            <label for="statusFilter">Visa status</label>
            <select id="statusFilter">
                <option value="pending">Väntar på granskning</option>
                <option value="approved">Godkända</option>
                <option value="rejected">Avslagna</option>
                <option value="alla">Alla</option>

            </select>
            <button type="button" class="btn" id="refreshApplications">Uppdatera lista</button>
        </div>
    </header>

    <div id="applicationsMessage" class="message" role="status" aria-live="polite" hidden></div>

    <div class="table-scroll">
    <div id="applicationsList" class="applications-list">
        {% if application == [] %}
        <p>Inga ansökningar mottagna än.</p>
        {% endif %}

        {% for application in applications %}
        <article class="application-item" data-status="{{ application.status }}">
            <input type="checkbox"
                   id="applicationToggle{{ application.id }}"
                   class="application-toggle"
                   data-application-id="{{ application.id }}">

            <div class="application-card">
                <label for="applicationToggle{{ application.id }}" class="application-summary">
                    <div class="application-info">
                        <span class="application-name">{{ application.name }}</span>
                        <span class="application-email">&lt;{{ application.email }}&gt;</span>
                        <span class="application-type">Typ: {{ application.account_type }}</span>
                        <span class="application-status
                            {% if application.status == 'pending' %}status-pending
                            {% elif application.status == 'approved' %}status-approved
                            {% elif application.status == 'rejected' %}status-rejected{% endif %}">
                            Status: {{ application.status|capitalize }}
                        </span>
                    </div>
                </label>

                <div class="application-actions-inline">
                    <button type="button"
                            class="btn btn-small show-details-btn"
                            data-app-id="{{ application.id }}">
                        Visa mer information
                    </button>
                </div>

                <div class="application-details" id="details-{{ application.id }}" hidden>
                    <p><strong>Organisationsnummer:</strong> {{ application.orgnr_normalized or "—" }}</p>
                    <p><strong>Företagsnamn:</strong> {{ application.company_name or "—" }}</p>
                    <p><strong>Fakturaadress:</strong> {{ application.invoice_address or "—" }}</p>
                    <p><strong>Kontaktperson:</strong> {{ application.invoice_contact or "—" }}</p>
                    <p><strong>Kommentar:</strong> {{ application.comment or "—" }}</p>
                    <p><strong>Skapad:</strong> {{ application.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>

                <div class="application-actions">
                    <form method="POST" action="{{ url_for('admin_applications') }}">
                        <input type="hidden" name="application_id" value="{{ application.id }}">
                        <input type="hidden" name="application_status" value="approved">
                        <button type="submit" class="btn btn-small btn-approve">
                            Godkänn
                        </button>
                    </form>

                    <form method="POST" action="{{ url_for('admin_applications') }}">
                        <input type="hidden" name="application_id" value="{{ application.id }}">
                        <input type="hidden" name="application_status" value="rejected">
                        <button type="submit" class="btn btn-small btn-deny">
                            Avvisa
                        </button>
                    </form>
                </div>
            </div>
        </article>
        {% endfor %}
    </div>
    </div>
</section>
<a class="btn-link" href="{{ url_for('admin') }}">Tillbaka till adminpanelen</a>

{% endblock %}
{% block head %}{{ super() }}<meta name="robots" content="noindex">{% endblock %}
{% block footer %}{{ super() }}{% endblock %}
