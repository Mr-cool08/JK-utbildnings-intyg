<!-- # Copyright (c) Liam Suorsa -->
{% extends 'base.html' %}
{% block title %}Admin — Konton{% endblock %}
{% block content %}
<h1>Admin — Konton</h1>
<p>Här skapar du standardkonton, hanterar intyg, uppdaterar kontouppgifter och skickar återställningslänkar.</p>

<nav class="admin-nav" aria-label="Administrationsnavigering">
    <a class="btn" href="{{ url_for('admin') }}">Start</a>
    <a class="btn" href="{{ url_for('admin_accounts') }}">Konton &amp; återställning</a>
    <a class="btn" href="{{ url_for('admin_certificates') }}">Intyg &amp; verifiering</a>
    <a class="btn" href="{{ url_for('admin_company_accounts') }}">Företagskonton</a>
    <a class="btn" href="{{ url_for('admin_applications') }}">Ansökningar</a>
    <a class="btn" href="{{ url_for('admin_invoicing') }}">Fakturering</a>
    <a class="btn" href="{{ url_for('admin_advanced') }}">Avancerade verktyg</a>
    <a class="btn" href="{{ url_for('admin_guide') }}">Guide</a>
</nav>

<section class="panel admin-tools" data-csrf-token="{{ csrf_token }}">
    <h2>Snabbverktyg</h2>
    <p>Fyll i eller rensa personnummer för flera formulär med en knapp.</p>
    <div class="button-row">
        <button id="fillLastPersonnummerBtn" type="button" class="btn btn-secondary">Fyll i senaste personnummer</button>
        <button id="copyLastPersonnummerBtn" type="button" class="btn btn-secondary">Kopiera senaste personnummer</button>
        <button id="clearAdminFormsBtn" type="button" class="btn btn-secondary">Rensa alla formulär</button>
    </div>
    <p id="adminToolsMessage" class="message" aria-live="polite" style="display:none"></p>
</section>

<section class="panel">
    <h2>Skapa ansökan</h2>
    <p>Använd detta formulär för att registrera ett användarkonto och ladda upp intyg.</p>
    <form id="adminForm" autocomplete="off" enctype="multipart/form-data" method="post" action="/admin">
        <label for="email">E-post</label>
        <input id="email" name="email" type="email" required placeholder="user@example.com" />

        <label for="username">Användarnamn</label>
        <input id="username" name="username" type="text" required placeholder="Fullständigt namn eller användarnamn" />

        <div class="row">
            <div class="col">
                <label for="personnummer">Personnummer</label>
                <input id="personnummer" name="personnummer" type="text" required placeholder="ÅÅMMDDXXXX" data-personnummer-target="true" />
                <small class="hint">Tillåtna format: ÅÅMMDDXXXX eller ÅÅÅÅMMDDXXXX, med eller utan bindestreck.</small>
            </div>

            <div class="col">
                <label for="pdf">Ladda upp PDF-filer</label>
                <input id="pdf" name="pdf" type="file" accept="application/pdf" multiple required />
                <small class="hint">Endast PDF-filer (max 100 MB totalt).</small>
            </div>
        </div>

        <fieldset id="fileCategoryGroup" class="category-group" hidden>
            <legend>Koppla kategori till varje PDF</legend>
            <div id="fileCategoryList" class="category-options file-category-list"></div>
            <small class="hint">Välj en kategori för varje uppladdad PDF.</small>
        </fieldset>

        <template id="fileCategoryTemplate">
            <div class="file-category-item">
                <span class="file-name"></span>
                <label>
                    <span class="sr-only">Kategori</span>
                    <select class="file-category-select" required>
                        <option value="">Välj kategori</option>
                        {% for group_label, items in category_groups %}
                            <optgroup label="{{ group_label }}">
                                {% for slug, label in items %}
                                <option value="{{ slug }}">{{ label }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </label>
            </div>
        </template>

        <button id="submitBtn" type="submit" class="btn">Skapa användarkonto</button>

        <div id="progressContainer" class="progress-container" style="display:none">
            <div id="progressBar" class="progress-bar"></div>
            <p class="progress-text">Skapar användarkonto… Detta kan ta upp till 30 sekunder.</p>
        </div>

        <div id="result" class="message" style="display:none"></div>
    </form>
</section>

<section class="panel">
    <h2>Hantera befintliga intyg</h2>
    <p>Fyll i personnummer och klicka på “Visa PDF:er”.</p>
    <form id="pdfLookupForm" class="inline-form" method="post">
        <label for="lookupPersonnummer">Personnummer</label>
        <input id="lookupPersonnummer" name="lookupPersonnummer" type="text" required placeholder="ÅÅMMDDXXXX" data-personnummer-target="true" />
        <button type="submit" class="btn">Visa PDF:er</button>
        <span id="pdfLookupMessage" class="message" aria-live="polite"></span>
    </form>

    <div id="pdfResults" class="card" hidden>
        <h3>Intyg</h3>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Filnamn</th>
                        <th>Kategorier</th>
                        <th>Uppladdad</th>
                        <th>Åtgärder</th>
                    </tr>
                </thead>
                <tbody id="pdfResultBody"></tbody>
            </table>
        </div>
    </div>
</section>

<section class="panel">
    <h2>Uppdatera användaruppgifter</h2>
    <p>Ändra namn och e-post för ett standardkonto eller en ansökan.</p>
    <form id="updateAccountForm" class="stacked-form" method="post">
        <label for="updatePersonnummer">Personnummer</label>
        <input id="updatePersonnummer" name="personnummer" type="text" required placeholder="ÅÅMMDDXXXX" data-personnummer-target="true" />

        <label for="updateUsername">Namn</label>
        <input id="updateUsername" name="username" type="text" required placeholder="För- och efternamn" />

        <label for="updateEmail">E-post</label>
        <input id="updateEmail" name="email" type="email" required placeholder="user@example.com" />

        <button type="submit" class="btn">Uppdatera konto</button>
        <p id="updateAccountMessage" class="message" aria-live="polite"></p>
    </form>
</section>

<section class="panel">
    <h2>Radera användarkonto</h2>
    <p>Välj ett konto i listan. Du kan ange e-post om du vill skicka en notifiering.</p>
    <form id="deleteAccountForm" class="stacked-form" method="post">
        <label for="deleteAccountSelect">Välj konto</label>
        <select id="deleteAccountSelect" name="personnummer_hash" required></select>

        <label for="deleteNotifyEmail">E-post för notifiering (valfritt)</label>
        <input id="deleteNotifyEmail" name="email" type="email" placeholder="user@example.com" />

        <div class="button-row">
            <button type="button" class="btn btn-secondary" id="refreshAccountList">Uppdatera lista</button>
            <button type="submit" class="btn btn-danger">Radera konto</button>
        </div>
        <p id="deleteAccountMessage" class="message" aria-live="polite"></p>
    </form>
</section>

<section class="panel">
    <h2>Lösenordsstatus för standardkonto</h2>
    <p>Kontrollera om användaren redan har skapat sitt lösenord och hämta skapa-konto-länken vid behov.</p>
    <form id="passwordStatusForm" class="stacked-form" method="post">
        <label for="passwordStatusPersonnummer">Personnummer</label>
        <input id="passwordStatusPersonnummer" name="personnummer" type="text" required placeholder="ÅÅMMDDXXXX" data-personnummer-target="true" />

        <label for="passwordStatusEmail">E-post</label>
        <input id="passwordStatusEmail" name="email" type="email" required placeholder="user@example.com" />

        <div class="button-row">
            <button type="submit" class="btn">Kontrollera lösenordsstatus</button>
            <button type="button" class="btn btn-secondary" id="sendCreateLinkBtn">Skicka skapa-konto-länk</button>
        </div>
        <p id="passwordStatusMessage" class="message" aria-live="polite"></p>
    </form>
</section>

<section class="panel">
    <h2>Skicka återställningsmejl</h2>
    <p>Bekräfta kontots uppgifter och skicka en ny länk för att välja lösenord.</p>
    <form id="resetForm" class="stacked-form" method="post">
        <label for="resetAccountType">Kontotyp</label>
        <select id="resetAccountType" name="accountType" required>
            <option value="standard">Standardkonto</option>
            <option value="foretagskonto">Företagskonto</option>
        </select>

        <div id="resetPersonnummerRow">
        <label for="resetPersonnummer">Personnummer</label>
        <input id="resetPersonnummer" name="resetPersonnummer" type="text" required placeholder="ÅÅMMDDXXXX" data-personnummer-target="true" />
        </div>

        <label for="resetEmail">E-post</label>
        <input id="resetEmail" name="resetEmail" type="email" required placeholder="user@example.com" />

        <button type="submit" class="btn">Skicka återställningslänk</button>
        <p id="resetMessage" class="message" aria-live="polite"></p>
    </form>
</section>

<dialog id="deleteAccountDialog" class="admin-dialog" aria-labelledby="deleteAccountTitle">
    <h3 id="deleteAccountTitle">Bekräfta radering</h3>
    <p class="dialog-warning">Du är på väg att radera kontot för <strong id="deleteAccountPersonnummerPreview">konto</strong>. Alla kopplade intyg, återställningar och kopplingar tas bort.</p>
    <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" id="cancelDeleteAccount">Avbryt</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteAccount">Ja, radera konto</button>
    </div>
</dialog>

<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
    window.APP_CATEGORIES = {{ categories|tojson }}
</script>
<script src="{{ url_for('static', filename='js/admin_panel_storage.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin_panel_personnummer.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin_panel_pdf.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin_panel_accounts.js') }}"></script>
{% endblock %}
<!-- # Copyright (c) Liam Suorsa -->
