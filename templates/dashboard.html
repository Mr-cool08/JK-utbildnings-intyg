{% extends 'base.html' %}
{% block title %}Översikt{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}
{% block content %}
<section class="dashboard">
    <h1>
        {% if user_name %}
            Hej {{ user_name }}! Här är dina intyg.
        {% else %}
            Hej! Här är dina intyg.
        {% endif %}
    </h1>
    <div class="support-actions" aria-label="Sektion för att kontakta supporten">
        <p class="support-text">Behöver du radera dina uppgifter? Kontakta oss så hjälper vi dig.</p>
        <a class="support-email-button" href="mailto:support@utbildningsintyg.se?subject=Beg%C3%A4ran%20om%20radering%20av%20anv%C3%A4ndardata&body=Hej%20supportteamet%2C%0A%0AJag%20vill%20beg%C3%A4ra%20att%20all%20min%20anv%C3%A4ndardata%20tas%20bort.%0A%0AV%C3%A4nligen%20bekr%C3%A4fta%20n%C3%A4r%20det%20%C3%A4r%20klart.%0A%0ATack!">Begär radering av mina uppgifter</a>
    </div>
    {% if category_summary %}
    <section class="category-list" aria-label="Tillgängliga kurskategorier">
        <h2>Kurskategorier</h2>
        <ul>
            {% for category in category_summary %}
            <li>
                <span class="category-label">{{ category.label }}</span>
                <span class="category-count-badge">{{ category.count }} intyg</span>
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    {% if grouped_pdfs %}
    <section class="category-groups" aria-label="Intyg sorterade efter kategori">
        {% for group in grouped_pdfs %}
        <article class="category-group">
            <header class="category-header">
                <h3>{{ group.label }}</h3>
                <p class="category-count">{{ group.pdfs | length }} intyg</p>
            </header>
            <ul class="pdf-list">
                {% for pdf in group.pdfs %}
                <li data-pdf-categories="{{ pdf.categories | join(',') }}">
                    <div class="pdf-entry">
                        <input
                            type="checkbox"
                            class="pdf-select"
                            data-share-select
                            value="{{ pdf.id }}"
                            data-pdf-name="{{ pdf.filename }}"
                            aria-label="Markera {{ pdf.filename }} för delning"
                        >
                        <div class="pdf-details">
                            <a href="{{ url_for('download_pdf', pdf_id=pdf.id) }}" download>
                                {{ pdf.filename }}
                            </a>
                            <span class="pdf-meta">
                                <strong>Kategorier:</strong>
                                {% if pdf.category_labels %}
                                    {{ pdf.category_labels | join(', ') }}
                                {% else %}
                                    Inte angiven
                                {% endif %}
                                <br>

                            </span>
                        </div>
                        <div class="pdf-actions">
                            <button
                                type="button"
                                class="share-button"
                                data-share-button
                                data-pdf-id="{{ pdf.id }}"
                                data-pdf-name="{{ pdf.filename }}"
                            >
                                Dela via e-post
                            </button>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </article>
        {% endfor %}
    </section>
    {% else %}
    <p>Inga PDF:er uppladdade.</p>
    {% endif %}
</section>

{% if grouped_pdfs %}
<div
    id="shareSelectionPopup"
    class="share-selection-popup"
    aria-live="polite"
    aria-hidden="true"
    hidden
>
    <div class="share-selection-popup__inner">
        <button
            type="button"
            class="share-selection-popup__close"
            aria-label="Stäng delningsrutan"
            data-share-selection-close
        >&times;</button>
        <p class="share-selection-popup__hint">
            Markera de intyg du vill dela och klicka på knappen för att skicka dem i samma e-post.
        </p>
        <button
            type="button"
            id="shareSelectedButton"
            class="share-selected-button"
            disabled
        >
            Dela markerade intyg
        </button>
    </div>
</div>
{% endif %}

<div id="shareModal" class="share-modal" aria-hidden="true">
    <div class="share-modal__backdrop" data-share-close></div>
    <div class="share-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle">
        <button type="button" class="share-modal__close" aria-label="Stäng delningsrutan" data-share-close>&times;</button>
        <h2 id="shareModalTitle">Dela intyg via e-post</h2>
        <p class="share-modal__lead">
            Du delar <strong id="shareDocumentSummary">intyget</strong>. Ange mottagarens e-postadress nedan.
        </p>
        <div class="share-modal__selection" id="shareDocumentSelection" hidden>
            <p class="share-modal__selection-lead">Följande intyg skickas som bilagor:</p>
            <ul id="shareDocumentList"></ul>
        </div>
        <form id="shareForm" class="share-form" novalidate>
            <label for="shareRecipientEmail">Mottagarens e-postadress</label>
            <input
                type="email"
                id="shareRecipientEmail"
                name="recipient_email"
                required
                autocomplete="email"
                placeholder="namn@example.se"
            >
            <button type="submit" class="share-submit">Skicka intyget</button>
        </form>
        <p class="share-modal__feedback" id="shareFeedback" role="alert" hidden></p>
    </div>
</div>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
