<!-- # Copyright (c) Liam Suorsa and Mika Suorsa -->
{% extends 'base.html' %}
{% block title %}Ansök om användarkonto – Utbildningsintyg{% endblock %}
{% block head %}
    <meta name="description" content="Ansök om användarkonto och få tillgång till Utbildningsintygets portal.">
{% endblock %}
{% block content %}
<section class="apply-hero" aria-labelledby="apply-title">
    <div class="apply-hero-content">

        <a class="back-link" href="{{ url_for('apply_account') }}" aria-label="Tillbaka till kontovalet">&#x2190; Tillbaka</a>

        <div class="apply-intro">
            <h1 id="apply-title">Ansök om användarkonto</h1>
            <p>Fyll i uppgifterna så kontaktar vi dig när kontot är klart.</p>
        </div>
        <form method="post" class="apply-form" novalidate>
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if form_errors %}
                <div class="message error" role="alert">
                    <ul>
                        {% for error in form_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% set name_error = field_errors.get('name') %}
            <label for="name">Fullständigt namn</label>
            <input
                id="name"
                name="name"
                type="text"
                value="{{ form_data.name }}"
                required
                autocomplete="name"
                class="{% if name_error %}input-error{% endif %}"
                aria-invalid="{{ 'true' if name_error else 'false' }}"
            >

            {% set email_error = field_errors.get('email') %}
            <label for="email">E-postadress</label>
            <input
                id="email"
                name="email"
                type="email"
                value="{{ form_data.email }}"
                required
                autocomplete="email"
                class="{% if email_error %}input-error{% endif %}"
                aria-invalid="{{ 'true' if email_error else 'false' }}"
            >

            {% set personnummer_error = field_errors.get('personnummer') %}
            <label for="personnummer">Personnummer</label>
            <input
                id="personnummer"
                name="personnummer"
                type="text"
                inputmode="numeric"
                pattern="[0-9\\s-]{10,13}"
                value="{{ form_data.personnummer }}"
                placeholder="ÅÅMMDDXXXX"
                required
                class="{% if personnummer_error %}input-error{% endif %}"
                aria-invalid="{{ 'true' if personnummer_error else 'false' }}"
                aria-describedby="personnummer-hint{% if personnummer_error %} personnummer-error{% endif %}"
            >
            <small class="hint" id="personnummer-hint">Skriv personnumret utan mellanslag, till exempel 8001011234.</small>
            {% if personnummer_error %}
                <p class="field-error-message" id="personnummer-error">Ange ett giltigt personnummer i formatet ÅÅMMDDXXXX.</p>
            {% endif %}

            {% set comment_error = field_errors.get('comment') %}
            <label for="comment">Extra information <span class="optional">(valfritt)</span></label>
            <textarea
                id="comment"
                name="comment"
                rows="4"
                class="{% if comment_error %}input-error{% endif %}"
                aria-invalid="{{ 'true' if comment_error else 'false' }}"
            >{{ form_data.comment }}</textarea>

            {% set terms_error = field_errors.get('terms_confirmed') %}
            <div class="form-consent">
                <input
                    id="terms_confirmed"
                    name="terms_confirmed"
                    type="checkbox"
                    value="1"
                    {% if form_data.terms_confirmed %}checked{% endif %}
                    required
                    class="{% if terms_error %}input-error{% endif %}"
                    aria-invalid="{{ 'true' if terms_error else 'false' }}"
                >
                <label for="terms_confirmed">
                    Jag har läst och förstått <a href="{{ url_for('terms_of_service') }}">användarvillkoren</a> och
                    <a href="{{ url_for('gdpr_info') }}">GDPR-policyn</a>.
                </label>
            </div>

            <button type="submit" class="btn">Skicka ansökan</button>
        </form>
        {% if success_message %}
            <div class="message success" role="status" aria-live="polite">
                {{ success_message }}
            </div>
        {% endif %}
    </div>
</section>

<section class="apply-info" aria-labelledby="info-title">
    <h2 id="info-title">Om användarkonton</h2>
    <p class="apply-price">Användarkonto är gratis för arbetsplatser anslutna till Utbildningsintyg.</p>
    <p>Företagskonton hanterar kopplingen mellan användare och företag vid behov.</p>
</section>

<section class="apply-steps" aria-labelledby="steps-title">
    <h2 id="steps-title">Så går ansökan till</h2>
    <ol class="apply-step-list">
        <li>
            <h3>Skicka in uppgifter</h3>
            <p>Berätta vem du är och hur vi kan nå dig.</p>
        </li>
        <li>
            <h3>Verifiering</h3>
            <p>Vi granskar uppgifterna och kontaktar dig om vi behöver kompletteringar.</p>
        </li>
        <li>
            <h3>Starta upp</h3>
            <p>Vid godkänd ansökan skickar vi inloggningsinstruktioner via e-post.</p>
        </li>
    </ol>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/form_error_highlight.js') }}" defer></script>
<script>
// Show an immediate toast when the user submits the application form to improve UX.
// This does not change server behaviour — it only displays a local "sending" state
// while the browser performs the normal form submission/redirect.
(function(){
    var form = document.querySelector('.apply-form');
    if(!form) return;
    form.addEventListener('submit', function onSubmit(e){
        try{
            // disable the submit button to avoid double submits
            var btn = form.querySelector('button[type=submit]');
            if(btn) { btn.disabled = true; btn.setAttribute('aria-disabled', 'true'); }

            // create or reuse toast container
            var container = document.querySelector('.toast-container');
            if(!container){
                container = document.createElement('div');
                container.className = 'toast-container';
                container.setAttribute('aria-live','polite');
                container.setAttribute('aria-atomic','true');
                document.body.appendChild(container);
            }

            // create a sending toast
            var toast = document.createElement('div');
            toast.className = 'toast info';
            toast.setAttribute('role','status');
            var msg = document.createElement('div');
            msg.className = 'toast-message';
            msg.textContent = 'Skickar ansökan…';
            var close = document.createElement('button');
            close.className = 'toast-close';
            close.setAttribute('aria-label','Stäng meddelande');
            close.textContent = '×';
            close.addEventListener('click', function(){ container.removeChild(toast); if(btn) btn.disabled = false; });
            toast.appendChild(msg);
            toast.appendChild(close);
            container.appendChild(toast);
            // animate in and auto-remove after 6s
            requestAnimationFrame(function(){ toast.classList.add('show'); });
            setTimeout(function(){ if(toast.parentNode) toast.parentNode.removeChild(toast); }, 6000);
        } catch(err){ /* fail silently */ }
        // allow the form to submit normally (do not call preventDefault)
    });
})();
</script>
{% endblock %}
